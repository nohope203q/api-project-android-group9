<!DOCTYPE html>
<html>
<head>
    <title>Chat App Real-time (C√≥ L·ªãch S·ª≠)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; display: flex; gap: 20px;}
        .left-panel { width: 30%; border-right: 1px solid #ccc; padding-right: 20px; }
        .right-panel { width: 70%; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 5px; background: #f0f0f0; }
        #conversation { height: 400px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; background: #fff; margin-bottom: 10px;}
        .msg { margin: 5px 0; padding: 8px; border-radius: 5px; max-width: 70%; word-wrap: break-word; clear: both;}
        .msg-me { background: #dcf8c6; float: right; text-align: right; }
        .msg-other { background: #e2e2e2; float: left; text-align: left; }
        input { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { padding: 10px; width: 100%; cursor: pointer; background: #007bff; color: white; border: none; margin-top: 5px;}
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="left-panel">
        <h3>1. C·∫•u h√¨nh</h3>
        <label>JWT Token:</label>
        <input type="text" id="jwtToken" placeholder="Paste Token v√†o ƒë√¢y...">
        <button onclick="connect()" id="btnConnect">üîå K·∫øt n·ªëi</button>
        <p id="status" style="color: red; font-weight: bold;">Ch∆∞a k·∫øt n·ªëi</p>
        
        <hr>

        <div id="selectUserArea" class="hidden">
            <h3>2. Chat v·ªõi ai?</h3>
            <label>Nh·∫≠p Email b·∫°n b√®:</label>
            <input type="text" id="recipientId" placeholder="friend@gmail.com">
            <button onclick="enterChatRoom()" style="background: #28a745;">üí¨ V√†o Chat Ngay</button>
            <p style="font-size: 12px; color: #666;">(B·∫•m n√∫t n√†y ƒë·ªÉ load tin nh·∫Øn c≈©)</p>
        </div>
    </div>

    <div class="right-panel hidden" id="chatPanel">
        <h3 id="chatTitle">ƒêang chat v·ªõi: ...</h3>
        <div id="conversation"></div>
        
        <div style="display: flex; gap: 10px;">
            <input type="text" id="message" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="handleEnter(event)">
            <button onclick="sendMessage()" style="width: 100px;">G·ª≠i üöÄ</button>
        </div>
    </div>

    <script>
        var stompClient = null;
        var myEmail = ""; 
        var currentRecipient = ""; // Bi·∫øn n√†y ƒë·ªÉ bi·∫øt ƒëang chat v·ªõi ai

        function connect() {
            var token = document.getElementById("jwtToken").value;
            if (!token) { alert("Thi·∫øu Token bro ∆°i!"); return; }

            // Gi·∫£i m√£ l·∫•y Email m√¨nh
            try {
                var base64Url = token.split('.')[1];
                var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                myEmail = JSON.parse(jsonPayload).sub; // Ho·∫∑c .email
            } catch (e) { console.error(e); }

            var socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);
            
            // T·∫Øt log debug c·ªßa th∆∞ vi·ªán cho ƒë·ª° r·ªëi m·∫Øt
            stompClient.debug = null; 

            stompClient.connect({ 'Authorization': 'Bearer ' + token }, function (frame) {
                document.getElementById("status").innerText = "Online: " + myEmail + " ‚úÖ";
                document.getElementById("status").style.color = "green";
                document.getElementById("selectUserArea").classList.remove("hidden");
                document.getElementById("btnConnect").disabled = true;

                stompClient.subscribe('/user/queue/messages', function (payload) {
                    var body = JSON.parse(payload.body);

                    // CHECK LO·∫†I TIN NH·∫ÆN
                    if (body.type === 'DELETE') {
                        // N·∫øu l√† l·ªánh x√≥a -> T√¨m div v√† x√≥a kh·ªèi m√†n h√¨nh
                        var msgDiv = document.getElementById("msg-" + body.messageId);
                        if (msgDiv) {
                            msgDiv.remove(); // X√≥a th·∫ª div ƒëi
                            console.log("ƒê√£ x√≥a tin nh·∫Øn ID: " + body.messageId);
                        }
                    } else {
                        // N·∫øu l√† tin nh·∫Øn th∆∞·ªùng -> Hi·ªán l√™n nh∆∞ c≈©
                        onMessageReceived(body);
                    }
                });

            }, function(error) { alert("L·ªói k·∫øt n·ªëi: " + error); });
        }

        // --- T√çNH NƒÇNG M·ªöI: LOAD L·ªäCH S·ª¨ CHAT ---
       function enterChatRoom() {
            var friendEmail = document.getElementById("recipientId").value;
            var token = document.getElementById("jwtToken").value; // L·∫•y token

            if(!friendEmail) { alert("Nh·∫≠p email b·∫°n b√® v√†o ƒë√£ bro!"); return; }

            currentRecipient = friendEmail;
            
            // Update giao di·ªán
            document.getElementById("chatPanel").classList.remove("hidden");
            document.getElementById("chatTitle").innerText = "ƒêang chat v·ªõi: " + friendEmail;
            document.getElementById("conversation").innerHTML = ""; 

            // --- S·ª¨A ·ªû ƒê√ÇY: Th√™m Header Authorization v√†o request ---
            fetch(`http://localhost:8080/messages/${myEmail}/${friendEmail}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token, // <--- CH√åA KH√ìA ·ªû ƒê√ÇY
                    'Content-Type': 'application/json'
                }
            }) 
            .then(response => {
                if (!response.ok) { throw new Error("L·ªói HTTP: " + response.status); }
                return response.json();
            })
            .then(messages => {
                console.log("L·ªãch s·ª≠ chat:", messages);
                if (messages.length === 0) {
                    console.log("Ch∆∞a c√≥ tin nh·∫Øn n√†o gi·ªØa 2 ng∆∞·ªùi n√†y.");
                }
                messages.forEach(msg => {
                    // Logic hi·ªÉn th·ªã: N·∫øu msg.senderId tr√πng v·ªõi myEmail th√¨ l√† 'me', ng∆∞·ª£c l·∫°i l√† 'other'
                    showChatBubble(msg, msg.senderId === myEmail ? 'me' : 'other');
                });
            })
            .catch(err => {
                console.error("L·ªói load history:", err);
                alert("Kh√¥ng load ƒë∆∞·ª£c tin nh·∫Øn c≈©! Check Console F12 xem l·ªói g√¨.");
            });
        }

        function sendMessage() {
            var content = document.getElementById("message").value;
            if(!content || !currentRecipient) return;

            var message = { recipientId: currentRecipient, content: content };

            stompClient.send("/app/chat", {}, JSON.stringify(message));
            
            // Hi·ªán ngay l√™n m√†n h√¨nh
            showChatBubble({ senderId: myEmail, content: content }, 'me');
            document.getElementById("message").value = "";
        }

        function requestDelete(msgId) {
            if (!confirm("Mu·ªën thu h·ªìi tin nh·∫Øn n√†y h·∫£ bro?")) return;

            var token = document.getElementById("jwtToken").value;

            fetch('http://localhost:8080/messages/' + msgId, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                if (response.ok) {
                    console.log("ƒê√£ g·ª≠i l·ªánh x√≥a!");
                    // Kh√¥ng c·∫ßn x√≥a UI ·ªü ƒë√¢y, ƒë·ª£i WebSocket tr·∫£ v·ªÅ l·ªánh x√≥a r·ªìi t·ª± n√≥ x√≥a
                } else {
                    alert("L·ªói kh√¥ng x√≥a ƒë∆∞·ª£c!");
                }
            })
            .catch(err => console.error(err));
        }
        function onMessageReceived(msg) {
            // Logic hi·ªÉn th·ªã th√¥ng minh:
            // Ch·ªâ hi·ªán tin nh·∫Øn n·∫øu n√≥ ƒë·∫øn t·ª´ ng∆∞·ªùi m√¨nh ƒêANG CHAT c√πng (currentRecipient)
            if (msg.senderId === currentRecipient) {
                showChatBubble(msg, 'other');
            } else {
                // N·∫øu ƒëang chat v·ªõi A m√† B nh·∫Øn t·ªõi -> Th√¥ng b√°o nh·∫π (Log ho·∫∑c Toast)
                console.log("üîî C√≥ tin nh·∫Øn m·ªõi t·ª´ " + msg.senderId + " (ƒêang ·∫©n v√¨ b·∫°n kh√¥ng chat v·ªõi h·ªç)");
                alert("üîî " + msg.senderId + " v·ª´a nh·∫Øn tin cho b·∫°n!");
            }
        }

       function showChatBubble(message, type) {
            var box = document.getElementById("conversation");
            
            // T·∫°o div bao quanh
            var div = document.createElement('div');
            div.className = 'msg ' + (type === 'me' ? 'msg-me' : 'msg-other');
            
            // üî• QUAN TR·ªåNG: G√°n ID cho th·∫ª div ƒë·ªÉ l√°t t√¨m m√† x√≥a
            // ID s·∫Ω c√≥ d·∫°ng: "msg-1", "msg-2"...
            div.id = "msg-" + message.id; 

            // N·ªôi dung tin nh·∫Øn
            var contentHtml = "<span>" + message.content + "</span>";
            
            // N·∫øu l√† tin m√¨nh g·ª≠i -> Th√™m n√∫t X√≥a
            if (type === 'me') {
                // N√∫t x√≥a g·ªçi h√†m requestDelete
                contentHtml += ` <button onclick="requestDelete(${message.id})" style="background:red; color:white; border:none; border-radius:50%; cursor:pointer; font-size:10px; margin-left:5px;">x</button>`;
            }

            div.innerHTML = contentHtml;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
    </script>
</body>
</html>